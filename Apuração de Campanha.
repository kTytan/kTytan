SELECT PCUSUARI.CODUSUR
      ,PCUSUARI.NOME
      ,PCUSUARI.CODSUPERVISOR
      ,PCSUPERV.NOME NOMESUP
,(' ') RAMO
      ,NVL(MOV.QTCLIENTE,0) QTCLIENTE
      ,NVL(MOV.QTMIX,0) QTMIX
      ,NVL(MOV.QTCLIENTE/(SELECT COUNT(*) FROM PCCLIENT)*100,0) PERQTCLIENTE 
      ,NVL(MOV.QTVENDA,0) QTVENDA
      ,NVL(MOV.VLVENDA,0) VLVENDA
      ,NVL(MOV.VLCUSTOFIN,0) VLCUSTOFIN
      ,NVL(DECODE(NVL(MOV.VLVENDA,0),0,0,(MOV.VLVENDA-NVL(MOV.VLCUSTOFIN,0))/MOV.VLVENDA*100),0) PERLUC
      ,NVL(MOV.QTPONTOS,0) QTPONTOS
      ,NVL(MOV.QTPONTOSVALOR,0) QTPONTOSVALOR
      ,NVL(MOV.PERCLIPOS,0) PERCLIPOS
      ,NVL(MOV.QTPONTOSCLIENTE,0) QTPONTOSCLIENTE
      ,NVL(MOV.QTPONTOSCLICAD,0) QTPONTOSCLICAD
      ,NVL(META.QTPONTOSMETA,0) QTPONTOSMETA 
      ,(NVL(MOV.QTPONTOS,0)+NVL(MOV.QTPONTOSVALOR,0)+NVL(PONTOSCLI.QTPONTOSCLIENTE,0)+NVL(MOV.QTPONTOSCLICAD,0)+NVL(META.QTPONTOSMETA,0)) AS QTTOTPONTOS
  FROM PCUSUARI
      ,PCSUPERV
, (select codusur, 
  qtcliente, 
  QTMIX, 
  QTVENDA, 
  VLVENDA, 
  VLCUSTOFIN, 
  QTPONTOS, 
  QTPONTOSVALOR, 
  QTPONTOSCLIENTE, 
  PERCLIPOS, 
  QTCLICAD, 
  QTPONTOSCLICAD 
 from(SELECT 
        PCMOV.CODUSUR 
              ,COUNT(DISTINCT(PCMOV.CODCLI)) QTCLIENTE
              ,COUNT(DISTINCT(PCMOV.CODPROD)) QTMIX
              ,SUM(DECODE(PCMOV.CODOPER,'S',(NVL(PCMOV.QT,0)),'SB',(NVL(PCMOV.QT,0)),'ED',NVL(PCMOV.QT,0)*(-1))) QTVENDA
              ,SUM(DECODE(PCMOV.CODOPER,'S',(NVL(PCMOV.QT,0)*NVL(PCMOV.PUNIT,0)),'ED',(NVL(PCMOV.QT,0)*NVL(PCMOV.PUNIT,0)*(-1))) ) VLVENDA
              ,SUM(DECODE(PCMOV.CODOPER,'S',(NVL(PCMOV.QT,0)*NVL(PCMOV.CUSTOFIN,0)),'ED',(NVL(PCMOV.QT,0)*NVL(PCMOV.CUSTOFIN,0)*(-1))) ) VLCUSTOFIN
              ,SUM(DECODE(PCMOV.CODOPER,'S',(NVL(PCMOV.QT,0)*NVL(PCPROMOI.QTPONTOS,0)),'ED',(NVL(PCMOV.QT,0)*NVL(PCPROMOI.QTPONTOS,0)*(-1)))) AS QTPONTOS
              ,SUM(DECODE(PCMOV.CODOPER,'S',((NVL(PCMOV.QT,0)*NVL(PCMOV.PUNIT,0))*NVL(PCPROMOI.QTPONTOSVALOR,0)),'ED',((NVL(PCMOV.QT,0)*NVL(PCMOV.PUNIT,0))*NVL(PCPROMOI.QTPONTOSVALOR,0)*(-1)))) AS QTPONTOSVALOR
              ,COUNT(DISTINCT(PCMOV.CODCLI))*MAX(PCPROMOI.QTPONTOSCLIENTE) QTPONTOSCLIENTE
              ,(COUNT(DISTINCT(PCMOV.CODCLI))/DECODE(MAX((SELECT COUNT(DISTINCT(PCCLIENT.CODCLI))
                                                                 FROM PCCLIENT
                                                                WHERE (CODUSUR1 = PCMOV.CODUSUR
                                                                   OR CODUSUR2 = PCMOV.CODUSUR)))
                                                     ,0,1
                                                     ,MAX((SELECT COUNT(DISTINCT(PCCLIENT.CODCLI))
                                                                  FROM PCCLIENT
                                                                 WHERE (CODUSUR1 = PCMOV.CODUSUR
                                                                    OR CODUSUR2 = PCMOV.CODUSUR)))))*100 AS PERCLIPOS
              ,MAX((SELECT COUNT(DISTINCT(PCCLIENT.CODCLI)) QTCLICAD
                           FROM PCCLIENT
                          WHERE (PCCLIENT.CODUSUR1 = PCMOV.CODUSUR
                             OR  PCCLIENT.CODUSUR2 = PCMOV.CODUSUR)
                            AND (PCCLIENT.DTEXCLUSAO IS NULL)
                            AND PCCLIENT.DTCADASTRO BETWEEN TO_DATE(:DTINICIO,'DD/MM/YYYY')
                                                        AND TO_DATE(:DTFIM,'DD/MM/YYYY'))) QTCLICAD
              ,MAX((SELECT COUNT(DISTINCT(PCCLIENT.CODCLI)) QTCLICAD
                           FROM PCCLIENT
                          WHERE (PCCLIENT.CODUSUR1 = PCMOV.CODUSUR
                             OR  PCCLIENT.CODUSUR2 = PCMOV.CODUSUR)
                            AND (PCCLIENT.DTEXCLUSAO IS NULL)
                            AND PCCLIENT.DTCADASTRO BETWEEN TO_DATE(:DTINICIO,'DD/MM/YYYY')
                                                        AND TO_DATE(:DTFIM,'DD/MM/YYYY'))* PCPROMOC.qtpontosnovosclientes ) QTPONTOSCLICAD
          FROM PCPROMOC
              ,PCPROMOI
              ,PCPRODUT
              ,PCFORNEC
              ,PCMOV
              ,PCCLIENT
              ,PCPEDC
              ,PCNFSAID
         WHERE PCPEDC.CODCLI = PCCLIENT.CODCLI AND PCNFSAID.NUMTRANSVENDA = PCMOV.NUMTRANSVENDA
           AND PCNFSAID.NUMPED = PCPEDC.NUMPED
           AND PCNFSAID.DTSAIDA >= TO_DATE(:DTINICIO,'DD/MM/YYYY')
           AND PCNFSAID.DTSAIDA <= TO_DATE(:DTFIM,'DD/MM/YYYY')
           AND PCPROMOC.CODPROMOCAO = PCPROMOI.CODPROMOCAO
      AND PCPEDC.CONDVENDA NOT IN (4,5,6,8,10,11,12,13,16,20)
AND PCMOV.DTMOV BETWEEN :DTINICIO AND :DTFIM 
         AND NVL(PCMOV.CODFILIAL,' ')  = :CODFILIAL
           AND NVL(PCMOV.CODOPER,'X') IN ('S','ED','SB')
           AND PCPROMOI.CODPROMOCAO IN ('15')
           AND PCMOV.CODPROD        = PCPRODUT.CODPROD
           AND PCPRODUT.CODFORNEC   = PCFORNEC.CODFORNEC
           AND PCMOV.DTCANCEL IS NULL 
           AND PCFORNEC.REVENDA     IN ('S', 'X') 
AND   PCMOV.CODPROD = PCPROMOI.CODPROD
  GROUP BY PCMOV.CODUSUR 
 having SUM(DECODE(PCMOV.CODOPER, 'S',(NVL(PCMOV.QT, 0)),'SB',(NVL(PCMOV.QT, 0)),'ED', NVL(PCMOV.QT, 0) * (-1))) >= max(NVL(PCPROMOI.Qtminitem, 0))) 
      ) MOV
 ,( SELECT CODUSUR,SUM(QTPONTOSCLIENTE) QTPONTOSCLIENTE FROM
     (SELECT
     DISTINCT(PCMOV.CODUSUR), PCMOV.CODPROD, 
     COUNT(DISTINCT(PCMOV.CODCLI))*PCPROMOI.QTPONTOSCLIENTE QTPONTOSCLIENTE
     FROM PCPRODUT, PCFORNEC, PCPROMOI, PCMOV
              ,PCCLIENT
              ,PCPEDC
              ,PCNFSAID
         WHERE PCPEDC.CODCLI = PCCLIENT.CODCLI AND PCNFSAID.NUMTRANSVENDA = PCMOV.NUMTRANSVENDA
           AND PCNFSAID.NUMPED = PCPEDC.NUMPED
           AND PCNFSAID.DTSAIDA >= TO_DATE(:DTINICIO,'DD/MM/YYYY')
           AND PCNFSAID.DTSAIDA <= TO_DATE(:DTFIM,'DD/MM/YYYY')
           AND PCMOV.DTCANCEL IS NULL 
      AND PCPEDC.CONDVENDA NOT IN (4,5,6,8,10,11,12,13,16,20)
       AND PCPROMOI.CODPROMOCAO IN ('15')
       AND PCMOV.DTMOV >= TO_DATE(:DTINICIO,'DD/MM/YYYY')
       AND PCMOV.DTMOV <= TO_DATE(:DTFIM,'DD/MM/YYYY')
       AND NVL(PCMOV.CODFILIAL,' ') = :CODFILIAL 
       AND NVL(PCMOV.CODOPER,'X') IN ('S','ED','SB')
       AND PCPRODUT.CODPROD = PCMOV.CODPROD
       AND PCPRODUT.CODFORNEC = PCFORNEC.CODFORNEC
    AND   PCMOV.CODPROD = PCPROMOI.CODPROD
      GROUP BY PCMOV.CODUSUR, PCMOV.CODPROD, PCPROMOI.QTPONTOSCLIENTE
 ) PONTOSCLI1
 GROUP BY CODUSUR
 ) PONTOSCLI
 ,( SELECT METAS.CODUSUR,
    SUM(METAS.QTPONTOSMETA) QTPONTOSMETA
    FROM 
 ( SELECT SUM(PCMETAPROD.METAUNID) METAUNID,
          SUM(PCMETAPROD.METAPESO) METAPESO,
          PCMOV.CODUSUR,
          SUM (DECODE(PCMOV.CODOPER, 'S',(NVL(PCMOV.QT, 0)),'SB',(NVL(PCMOV.QT,0)) ,'ED',NVL(PCMOV.QT, 0)*(-1))) QTUNID,
          SUM (DECODE(PCMOV.CODOPER, 'S', NVL(PCMOV.QT,0)*NVL(PCPRODUT.PESOLIQ,0), 'ED', NVL(PCMOV.QT,0)*NVL(PCPRODUT.PESOLIQ,0)*(-1),0)) QTPESOLIQ,
          SUM (DECODE(PCMOV.CODOPER, 'S', NVL(PCMOV.QT,0)*NVL(PCPRODUT.PESOBRUTO,0), 'ED', NVL(PCMOV.QT,0)*NVL(PCPRODUT.PESOBRUTO,0)*(-1),0)) QTPESOBRUTO
      ,DECODE(SIGN(SUM(DECODE(PCMOV.CODOPER, 'S',(NVL(PCMOV.QT, 0)),'ED',NVL(PCMOV.QT, 0)*(-1))) - SUM(PCMETAPROD.METAUNID))
            ,1,DECODE(SIGN(0 - SUM(PCMETAPROD.METAUNID))
                      ,-1, MAX(PCPROMOI.QTPONTOSMETA)
                      ,0)
            ,DECODE(SIGN (SUM (DECODE(PCMOV.CODOPER, 'S', NVL(PCMOV.QT,0)*NVL(PCPRODUT.PESOBRUTO,0), 'ED', NVL(PCMOV.QT,0)*NVL(PCPRODUT.PESOBRUTO,0)*(-1),0)) - SUM(PCMETAPROD.METAPESO))
                   ,1,DECODE(SIGN(0 - SUM(PCMETAPROD.METAPESO))
                            ,-1, MAX(PCPROMOI.QTMETA))
                            ,0)
            ,0) QTPONTOSMETA
       FROM PCPRODUT
           ,PCMETAPROD
           ,PCFORNEC
           ,PCPROMOI
           ,PCMOV
           ,PCCLIENT
           ,PCPEDC
           ,PCNFSAID
         WHERE PCPEDC.CODCLI = PCCLIENT.CODCLI AND PCNFSAID.NUMTRANSVENDA = PCMOV.NUMTRANSVENDA
           AND PCNFSAID.NUMPED = PCPEDC.NUMPED
           AND PCNFSAID.DTSAIDA >= TO_DATE(:DTINICIO,'DD/MM/YYYY')
           AND PCNFSAID.DTSAIDA <= TO_DATE(:DTFIM,'DD/MM/YYYY')
           AND PCMOV.DTCANCEL IS NULL 
      AND PCPEDC.CONDVENDA NOT IN (4,5,6,8,10,11,12,13,16,20)
        AND PCMOV.DTMOV >= TO_DATE(:DTINICIO,'DD/MM/YYYY')
        AND PCMOV.DTMOV <= TO_DATE(:DTFIM,'DD/MM/YYYY')
        AND NVL(PCMOV.CODFILIAL,' ') = :CODFILIAL
        AND NVL(PCMOV.CODOPER,'X') IN ('S','ED','SB')
        AND PCMETAPROD.CODCAMPANHA IN ('15')
        AND PCMOV.CODPROD = PCMETAPROD.CODPROD(+)
        AND PCMOV.CODPROD = PCPRODUT.CODPROD
        AND PCPRODUT.CODFORNEC = PCFORNEC.CODFORNEC
        AND PCFORNEC.REVENDA    IN ('S', 'X') 
        AND PCMOV.CODUSUR = PCMETAPROD.CODUSUR(+)
        AND PCMETAPROD.CODCAMPANHA = PCPROMOI.CODPROMOCAO
     AND   PCMOV.CODPROD = PCPROMOI.CODPROD
      GROUP BY PCMOV.CODUSUR
    HAVING (SUM (DECODE(PCMOV.CODOPER, 'S',(NVL(PCMOV.QT, 0)),'SB',(NVL(PCMOV.QT,0)) ,'ED',NVL(PCMOV.QT, 0)*(-1))) >
           SUM(PCMETAPROD.METAUNID) ) OR
           (SUM (DECODE(PCMOV.CODOPER, 'S', NVL(PCMOV.QT,0)*NVL(PCPRODUT.PESOBRUTO,0), 'ED', NVL(PCMOV.QT,0)*NVL(PCPRODUT.PESOBRUTO,0)*(-1),0)) >
              SUM(PCMETAPROD.METAPESO))
   ) METAS
        GROUP BY METAS.CODUSUR
 ) META
  WHERE PCUSUARI.CODSUPERVISOR      = PCSUPERV.CODSUPERVISOR
    AND PCUSUARI.CODUSUR            = MOV.CODUSUR(+)  
    AND PCUSUARI.CODUSUR            = PONTOSCLI.CODUSUR(+)
    AND PCUSUARI.CODUSUR            = META.CODUSUR (+)
   AND PCUSUARI.CODUSUR = :codusur 
   AND PCUSUARI.CODSUPERVISOR IN (:CODSUPERVISOR)
AND PCUSUARI.CODSUPERVISOR IN (:CODSUPERVISOR)
ORDER BY QTVENDA DESC
